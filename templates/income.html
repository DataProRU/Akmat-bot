{% extends 'base.html' %}

{% block title %}Доходы{% endblock %}


{% block nav %}
<nav class="nav-container">
    <div class="add-entry-btn tooltip">✚
        <span class="tooltip-text">Добавить запись</span>
    </div>
    <form action="/filtered-income" method="get" class="nav-form-filter">
        <select name="day" id="day" class="nav-select">
            <option value="">День</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
        </select>

        <select name="month" id="month" class="nav-select">
            <option value="">Месяц</option>
            <option value="1">Январь</option>
            <option value="2">Февраль</option>
            <option value="3">Март</option>
            <option value="4">Апрель</option>
            <option value="5">Май</option>
            <option value="6">Июнь</option>
            <option value="7">Июль</option>
            <option value="8">Август</option>
            <option value="9">Сентябрь</option>
            <option value="10">Октябрь</option>
            <option value="11">Ноябрь</option>
            <option value="12">Декабрь</option>
        </select>

        <select name="year" id="year" class="nav-select">
            <option value="">Год</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
        </select>

        <div class="reset-filter tooltip">
            <input class="reset-filter-btn" type="reset" value=""><!--✖-->
            <span class="tooltip-text" >Сбросить фильтры</span>
        </div>
    </form>
</nav>
{% endblock %}


{% block content %}
<script>
    function openEditForm(data) {
        document.getElementById('edit-id').value = data.id;
        document.getElementById('edit-flight_id').value = data.flight_number;
        document.getElementById('edit-technique_id').value = data.technique_id;
        document.getElementById('edit-price').value = data.price;
        document.getElementById('edit-discount').value = data.discount;
        document.getElementById('edit-prepayment').checked = data.prepayment === 'Yes';
        document.getElementById('edit-payment_type').value = data.payment_type;
        document.getElementById('edit-source_id').value = data.source_id;
        document.getElementById('edit-transfer').value = data.transfer;
        document.getElementById('edit-note').value = data.note;

        document.getElementById('edit-form-container').style.display = 'block';
    }

    document.querySelector('.close-edit-form-btn').addEventListener('click', function () {
        document.getElementById('edit-form-container').style.display = 'none';
    });
</script>
<table class="table-data" id="table-data">
    <thead>
        <tr class="trow-head">
            <th class="trow-head-data">Дата<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Номер рейса<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Вид маршрута<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Вид техники<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Инструктор<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Скидка<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Предоплата<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Стоимость<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Вид оплаты<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Источник<div class="resizer"></div>
            </th>
            <th class="trow-head-data">Примечание<div class="resizer"></div>
            </th>
            <th class="trow-head-data th-filter"></th>
        </tr>
    </thead>
    <tbody class="table-body" id="table-body">
        {% for item in data %}
        <tr class="trow">
            <td class="tcol">{{ item.created_at }}</td>
            <td class="tcol tcol-num">{{ item.flight_number }}</td>
            <td class="tcol">{{ item.flight_name }}</td>
            <td class="tcol">{{ item.technique_name }}</td>
            <td class="tcol">{{ item.user_name }}</td>
            <td class="tcol tcol-num">{{ item.discount }}</td>
            <td class="tcol tcol-num">{{ item.prepayment }}</td>
            <td class="tcol tcol-num">{{ item.price }}</td>
            <td class="tcol">{{ item.payment_type }}</td>
            <td class="tcol">{{ item.source }}</td>
            <td class="tcol">{{ item.note }}</td>

            <!-- Здесь кнопки редактирования и удаления -->
            <td class="tcol tcol-filter">
                <!-- Форма для удаления -->
                <form action="/delete_flight/" method="post">
                    <input type="hidden" name="id" value="{{ item.id }}">
                    <button type="submit" class="tcol-filter-delete">D</button>
                </form>
                <!-- Кнопка для редактирования -->
                <button type="button" class="tcol-filter-edit" onclick="openEditForm({
                        id: '{{ item.id }}',
                        flight_number: '{{ item.flight_number }}',
                        technique_id: '{{ item.technique_id }}',
                        price: '{{ item.price }}',
                        discount: '{{ item.discount }}',
                        prepayment: '{{ item.prepayment }}',
                        payment_type: '{{ item.payment_type }}',
                        source_id: '{{ item.source_id }}',
                        transfer: '{{ item.transfer }}',
                        note: '{{ item.note }}'
                    })">E</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>

</table>

<section id="add-form-container">

    <div class="form-header">
        <h2 class="form-title">Новая запись</h2>
        <button class="close-form-btn">✖</button>
    </div>

    <form action="/submit" method="POST" class="add-entry-form">
        <div class="form-part">
            <div class="form-element">
                <label for="flight_id">Номер рейса</label>
                <input type="number" id="flight_id" name="flight_id" class="middle-element" required>
            </div>

            <div class="form-element">
                <label for="technique_id">Вид техники</label>
                <select name="technique_id" id="technique_id" class="middle-element" required>
                    <option selected disabled hidden></option>
                    <option value="1">--вид1--</option>
                    <option value="2">--вид2--</option>
                    <option value="3">--вид3--</option>
                </select>
            </div>
        </div>

        <div class="form-part">
            <div class="form-element">
                <label for="price">Стоимость</label>
                <input type="number" id="price" name="price" class="small-element" step="0.01" required>
            </div>

            <div class="form-element">
                <label for="discount">Скидка</label>
                <input type="number" id="discount" name="discount" class="small-element" step="0.01">
            </div>

            <div class="form-element">
                <label for="prepayment">Предоплата</label>
                <input type="checkbox" id="prepayment" name="prepayment" class="small-element">
            </div>
        </div>

        <div class="form-part">
            <div class="form-element">
                <label for="payment_type_id">Вид оплаты</label>
                <select name="payment_type_id" id="payment_type_id" class="middle-element" required>
                    <option selected disabled hidden></option>
                    <option value="1">QR</option>
                    <option value="2">Наличные</option>
                    <option value="3">Перевод</option>
                    <option value="4">Постоплата</option>
                    <option value="5">Безнал</option>
                </select>
            </div>

            <div class="form-element">
                <label for="source_id">Источник</label>
                <select name="source_id" id="source_id" class="middle-element" required>
                    <option selected disabled hidden></option>
                    <option value="1">Интернет</option>
                    <option value="2">Поляна</option>
                    <option value="3">Инфо офис</option>
                    <option value="4">Отели</option>
                    <option value="5">Агенты</option>
                </select>
            </div>
        </div>

        <div class="form-element">
            <label for="transfer">Трансфер</label>
            <input type="number" id="transfer" name="transfer" class="small-element" step="0.01">
        </div>

        <div class="form-element">
            <label for="note">Комментарий</label>
            <textarea id="note" name="note"></textarea>
        </div>


        <div class="form-btns">
            <input type="reset" class="form-btn-reset">
            <input type="submit" value="Добавить" class="form-btn-submit">
        </div>
    </form>
</section>
</section>

<section id="edit-form-container" style="display: none;">
    <div class="form-header">
        <h2 class="form-title">Редактирование записи</h2>
        <button class="close-edit-form-btn">✖</button>
    </div>

    <form action="/update_flight/" method="POST" class="edit-entry-form" id="edit-entry-form">
        <input type="hidden" id="edit-id" name="id">

        <div class="form-part">
            <div class="form-element">
                <label for="edit-flight_id">Номер рейса</label>
                <input type="number" id="edit-flight_id" name="flight_number" class="middle-element" required>
            </div>

            <div class="form-element">
                <label for="edit-technique_id">Вид техники</label>
                <select name="technique_id" id="edit-technique_id" class="middle-element" required>
                    <option value="1">--вид1--</option>
                    <option value="2">--вид2--</option>
                    <option value="3">--вид3--</option>
                </select>
            </div>
        </div>

        <div class="form-part">
            <div class="form-element">
                <label for="edit-price">Стоимость</label>
                <input type="number" id="edit-price" name="price" class="small-element" step="0.01" required>
            </div>

            <div class="form-element">
                <label for="edit-discount">Скидка</label>
                <input type="number" id="edit-discount" name="discount" class="small-element" step="0.01">
            </div>

            <div class="form-element">
                <label for="edit-prepayment">Предоплата</label>
                <input type="checkbox" id="edit-prepayment" name="prepayment">
            </div>
        </div>

        <div class="form-part">
            <div class="form-element">
                <label for="edit-payment_type">Вид оплаты</label>
                <select name="payment_type" id="edit-payment_type" class="middle-element" required>
                    <option value="QR">QR</option>
                    <option value="Наличные">Наличные</option>
                    <option value="Перевод">Перевод</option>
                    <option value="Постоплата">Постоплата</option>
                    <option value="Безнал">Безнал</option>
                </select>
            </div>

            <div class="form-element">
                <label for="edit-source_id">Источник</label>
                <select name="source_id" id="edit-source_id" class="middle-element" required>
                    <option value="1">Интернет</option>
                    <option value="2">Поляна</option>
                    <option value="3">Инфо офис</option>
                    <option value="4">Отели</option>
                    <option value="5">Агенты</option>
                </select>
            </div>
        </div>

        <div class="form-element">
            <label for="edit-transfer">Трансфер</label>
            <input type="number" id="edit-transfer" name="transfer" class="small-element" step="0.01">
        </div>

        <div class="form-element">
            <label for="edit-note">Комментарий</label>
            <textarea id="edit-note" name="note"></textarea>
        </div>

        <div class="form-btns">
            <input type="reset" class="form-btn-reset">
            <input type="submit" value="Сохранить изменения" class="form-btn-submit">
        </div>
    </form>
</section>


<div class="pagination">
    <ul class="pagination-list">
        {% if page > 1 %}
        <li><a href="?page=1">&laquo; Первая</a></li>
        <li><a href="?page={{ page - 1 }}">&lsaquo; Предыдущая</a></li>
        {% endif %}

        {% for p in range((page - 2) if page > 2 else 1, (page + 2) if page < total_pages - 1 else total_pages + 1) %}
            <li class="{% if p == page %}active{% endif %}">
            <a href="?page={{ p }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if page < total_pages %} <li><a href="?page={{ page + 1 }}">Следующая &rsaquo;</a></li>
                <li><a href="?page={{ total_pages }}">Последняя &raquo;</a></li>
                {% endif %}
    </ul>
</div>

{% endblock %}